{#
    hyperboria-theme/layout.html
    ~~~~~~~~~~~~~~~~~~~

    Sphinx layout template for the default theme.

    :copyright: Copyright 2007-2014 by the Sphinx team, see AUTHORS.
    :license: BSD, see LICENSE for details.
#}

{%- extends "basic/layout.html" %}

{% set sidebar_menu = [
    {'title': 'About :', 'sublinks': [
        {'title': 'Asking Questions *TODO*', 'path':'todo'},
        {'title': 'Peering', 'path':'faq/peering'},
        {'title': 'Security', 'path':'faq/security'},
        {'title': 'Meshlocals', 'path':'meshlocals/intro', 'sublinks': [
            {'title': 'Meshlocals around the world', 'path':'meshlocals/existing/index'}, 
            {'title': 'Starting a Meshlocal', 'path':'meshlocals/diy'}
        ]},
        {'title': 'FAQ', 'path':'faq/general'},
        {'title': 'Achievements', 'path':'achievements'},
        {'title': 'Glossary', 'path':'faq/glossary'},
    ]},
    {'title': 'The cjdns routing protocol', 'sublinks': [
        {'title': 'About', 'sublinks': [
            {'title': 'Goals', 'path':'project-goals'}, 
            {'title': 'Goals (russian}', 'path':'project-goals-ru'},
            {'title': 'Original whitepaper', 'path':'Whitepaper'},
            {'title': 'Brief intro', 'path':'intro'},
            {'title': 'Security Specification', 'path':'security-specifications'},
        ]},
        {'title': 'Installation', 'sublinks': [
            {'title': 'Most Linuxes *TODO*', 'path':'todo'},
            {'title': 'OpenWrt', 'path':'install/openwrt'},
            {'title': 'Android *TODO*', 'path':'todo'},
            {'title': 'Firefox OS *TODO*', 'path':'todo'},
            {'title': 'OS X', 'path':'install/osx'},
            {'title': 'Debian Wheezy', 'path':'install/debian-wheezy'},
            {'title': 'Debian Jessie', 'path':'install/debian-jessie'},
            {'title': 'Arch', 'path':'install/arch'},
            {'title': 'Fedora', 'path':'install/fedora'},
            {'title': 'FreeBSD *TODO*', 'path':'todo'},
            {'title': 'OpenBSD *TODO*', 'path':'todo'},
            {'title': 'Windows', 'path':'install/windows'},
            {'title': 'Building *on* Windows', 'path':'install/build-on-windows'},
            {'title': 'Securing your Windows system', 'path':'config/windows-firewall'},
        ]},
        {'title': 'Usage', 'sublinks': [
            {'title': 'Setup', 'path':'config/configure'},
            {'title': 'Operator guidelines', 'path':'cjdns/operator-guidelines'},
            {'title': 'Securing your system', 'path':'config/network-services'},
            {'title': 'Tools *TODO*', 'path':'todo'},
            {'title': 'Third party tools', 'path':'ctrls'},
            {'title': 'Admin API', 'path':'cjdns/admin-api'},
        ]},
        {'title': 'Working with cjdns', 'sublinks': [
            {'title': 'Anatomy of cjdroute', 'path':'cjdns/anatomy'},
            {'title': 'Peering over UDP', 'path':'cjdns/peering-over-UDP-IP'},
            {'title': 'nodeinfo.json', 'path':'cjdns/nodeinfo-json'},
            {'title': 'Changelog', 'path':'cjdns/changelog'},
        ]},
        {'title': 'HowTo', 'sublinks': [
            {'title': 'Using cjdns as a VPN', 'path':'config/tunnel'},
            {'title': 'Shorewall and VPN gateway', 'path':'config/shorewall-and-vpn-gateway-howto'},
            {'title': 'NAT gateway for non-cjdns nodes', 'path':'config/nat-gateway'},
            {'title': 'Autostart at login', 'path':'config/autostart-at-login'},
            {'title': 'Run as non-root user', 'path':'config/non-root-user'},
        ]},
        {'title': 'Troubleshooting', 'sublinks': [
            {'title': 'Read this first', 'path':'bugs/policy'},
            {'title': 'Memory leaks', 'path':'bugs/debugging-memory-leaks'},
            {'title': 'SecComp', 'path':'bugs/Seccomp'},
            {'title': 'Analyzing network IO', 'path':'traffic-analysis'},
        ]},
        {'title': 'Known issues', 'sublinks': [
            {'title': 'Horizon', 'path':'bugs/horizon'},
            {'title': 'Black Hole', 'path':'bugs/black-hole'},
            {'title': 'Secret Santa', 'path':'bugs/santa'},
        ]},
        {'title': 'Configurator timeout', 'sublinks': [
            {'title': 'Firewall on localhost', 'path':'bugs/configurator-timeout'},
            {'title': 'UDP overflow', 'path':'bugs/connectTo-overflow'},
            {'title': 'Hidden Peers', 'path':'bugs/hidden-peers'},
        ]},
        {'title': 'OS/distro-specific quirks', 'path':'bugs/distro-quirks'},
        {'title': 'Reporting bugs', 'path':'bugs/reporting'}
    ]}
]
%}

{%- block sidebartoc %}
    {%- include "localtoc.html" %}
    <h3><a href="{{ pathto('index') }}">Menu</a></h3>
    <ul class="sidebar_menu">
        {% for link in sidebar_menu %}
            {% if link.sublinks %}
                <h4>{{ link.title }}</h4>
                {% for sublink1 in link.sublinks %}
                    {% if sublink1.sublinks %}
                    <li class="subtitle">{{ sublink1.title }}</li>
                    <ul>
                        {% for sublink2 in sublink1.sublinks %}
                            {% if sublink2.path == 'todo' %}
                            <li class='todo'>{{ sublink2.title }}</li>
                            {% else %}
                            <li><a href="{{ pathto(sublink2.path) }}">{{ sublink2.title }}</a></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                    {% elif sublink1.path == 'todo' %}
                    <li class='todo'>{{ sublink1.title }}</li>
                    {% else %}
                    <li><a href="{{ pathto(sublink1.path) }}">{{ sublink1.title }}</a></li>
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    </ul>
{%- endblock %}

{%- macro chapter_switcher() %}
    <div class="chapter_switcher">
    {% for link in sidebar_menu %}
        {% for sublink1 in link.sublinks %}
        {% set sublink1_index = link.sublinks.index(sublink1) %}
        {% set last_chapter = link.sublinks[ sublink1_index - 1 ] %}
        {% if sublink1_index - 1 < 0 %}
            
        {% endif %}
        {% set next_chapter = link.sublinks[ sublink1_index + 1 ] %}
            {% if sublink1.path == pagename %}
                {{ load_next_chapter(next_chapter) }}
                
                {{ load_last_chapter(last_chapter) }}
        
            {% else %}
                {% if sublink1.sublinks %}
                    {% for sublink2 in sublink1.sublinks %}
                        {% if sublink2.path == pagename %}
                        {% set sublink2_index = sublink1.sublinks.index(sublink2) %}
                        {% set is_first = (sublink2_index == 0) %}
                        {% set is_last = (sublink2_index == sublink1.sublinks|length - 1) %}
                            {% if is_first %}
                                {{ load_last_chapter(last_chapter) }}
                            {% else %}
                            <h3 class="chapter last"><a href="{{ pathto(sublink1.sublinks[ sublink2_index - 1 ].path) }}">previous: {{ sublink1.sublinks[ sublink2_index - 1 ].title }}</a></h3>
                            {% endif %}
                            
                            {% if is_last %}
                                {{ load_next_chapter(next_chapter) }}
                            {% else %}
                            <h3 class="chapter next"><a href="{{ pathto(sublink1.sublinks[ sublink2_index + 1 ].path) }}">next: {{ sublink1.sublinks[ sublink2_index + 1 ].title }}</a></h3>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    </div>
{%- endmacro %}

{%- macro load_last_chapter(last_chapter) %}
    {% if last_chapter %}
        {% if last_chapter.sublinks %}
        <h3 class="chapter last"><a href="{{ pathto(last_chapter.sublinks[0].path) }}">previous: {{  last_chapter.sublinks[0].title }}</a></h3>
        {% else %}
        <h3 class="chapter last"><a href="{{ pathto(last_chapter.path) }}">previous: {{ last_chapter.title }}</a></h3>
        {% endif %}
    {% endif %}
{%- endmacro %}

{%- macro load_next_chapter(next_chapter) %}
    {% if next_chapter %}
        {% if next_chapter.sublinks %}  
        <h3 class="chapter next"><a href="{{ pathto(next_chapter.sublinks[0].path) }}">next: {{ next_chapter.sublinks[0].title }}</a></h3>
        {% else %}
        <h3 class="chapter next"><a href="{{ pathto(next_chapter.path) }}">next: {{ next_chapter.title }}</a></h3>
        {% endif %}
    {% endif %}
{%- endmacro %}


