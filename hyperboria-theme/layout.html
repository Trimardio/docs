{#
    hyperboria-theme/layout.html
    ~~~~~~~~~~~~~~~~~~~

    Sphinx layout template for the hyberboria doc
    
    Note that we used a hack to use .md file with shpinx. Thus a need for a lot of jinja functions in order to reestablish some basic sphinx functions. 
#}




{%- extends "basic/layout.html" %}

{# Removes relbar at the top #}
{%- block relbar1 %}{% endblock %}

{# Removes relbar at the end #}
{%- block relbar2 %}{% endblock %}

{# Removes link for .md or .txt source in the menu #}
{%- block sidebarsourcelink %}{% endblock %}

{# Add script and css links #}
{%- block extrahead %} 
<script>
    $(document).load(function() {
        mermaid.initialize();
    });
</script>
{% endblock %}
{% set script_files = script_files + ["_static/analytics.js"] %}
{% set script_files = script_files + ["_static/analytics.h.js"] %}
{% set script_files = script_files + ["_static/mermaid.min.js"] %}
{% set script_files = script_files + ["_static/main.js"] %}
{% set css_files = css_files + ["_static/css/font-awesome.min.css"] %}


{# Whole menu displayed on the left is in this object. Note that it was copied on hand from index.md. TODO: this need to be done automatically #}
{% set sidebar_menu = [
    {'title': 'About', 'sublinks': [
        {'title': 'Asking Questions *TODO*', 'path':'wtfm', 'todo': True},
        {'title': 'Peering', 'path':'faq/peering'},
        {'title': 'Security', 'path':'faq/security'},
        {'title': 'Meshlocals', 'path':'meshlocals/intro', 'sublinks': [
            {'title': 'Meshlocals around the world', 'path':'meshlocals/existing/index'}, 
            {'title': 'Starting a Meshlocal', 'path':'meshlocals/diy'}
        ]},
        {'title': 'FAQ', 'path':'faq/general'},
        {'title': 'Achievements', 'path':'achievements'},
        {'title': 'Glossary', 'path':'faq/glossary'},
    ]},
    {'title': 'The cjdns routing protocol', 'sublinks': [
        {'title': 'About', 'sublinks': [
            {'title': 'Goals', 'path':'project-goals'}, 
            {'title': 'Goals (russian}', 'path':'project-goals-ru'},
            {'title': 'Original whitepaper', 'path':'Whitepaper'},
            {'title': 'Brief intro', 'path':'intro'},
            {'title': 'Security Specification', 'path':'security-specifications'},
        ]},
        {'title': 'Installation', 'sublinks': [
            {'title': 'Most Linuxes *TODO*', 'path':'install/linux', 'todo': True},
            {'title': 'OpenWrt', 'path':'install/openwrt'},
            {'title': 'Android *TODO*', 'path':'install/android', 'todo': True},
            {'title': 'Firefox OS *TODO*', 'path':'install/firefoxos', 'todo': True},
            {'title': 'OS X', 'path':'install/osx'},
            {'title': 'Debian Wheezy', 'path':'install/debian-wheezy'},
            {'title': 'Debian Jessie', 'path':'install/debian-jessie'},
            {'title': 'Arch', 'path':'install/arch'},
            {'title': 'Fedora', 'path':'install/fedora'},
            {'title': 'FreeBSD *TODO*', 'path':'install/freebsd', 'todo': True},
            {'title': 'OpenBSD *TODO*', 'path':'install/openbsd', 'todo': True},
            {'title': 'Windows', 'path':'install/windows'},
            {'title': 'Building *on* Windows', 'path':'install/build-on-windows'},
            {'title': 'Securing your Windows system', 'path':'config/windows-firewall'},
        ]},
        {'title': 'Usage', 'sublinks': [
            {'title': 'Setup', 'path':'config/configure'},
            {'title': 'Operator guidelines', 'path':'cjdns/operator-guidelines'},
            {'title': 'Securing your system', 'path':'config/network-services'},
            {'title': 'Tools *TODO*', 'path':'tools/index', 'todo': True},
            {'title': 'Third party tools', 'path':'ctrls'},
            {'title': 'Admin API', 'path':'cjdns/admin-api'},
        ]},
        {'title': 'Working with cjdns', 'sublinks': [
            {'title': 'Anatomy of cjdroute', 'path':'cjdns/anatomy'},
            {'title': 'Peering over UDP', 'path':'cjdns/peering-over-UDP-IP'},
            {'title': 'nodeinfo.json', 'path':'cjdns/nodeinfo-json'},
            {'title': 'Changelog', 'path':'cjdns/changelog'},
        ]},
        {'title': 'HowTo', 'sublinks': [
            {'title': 'Using cjdns as a VPN', 'path':'config/tunnel'},
            {'title': 'Shorewall and VPN gateway', 'path':'config/shorewall-and-vpn-gateway-howto'},
            {'title': 'NAT gateway for non-cjdns nodes', 'path':'config/nat-gateway'},
            {'title': 'Autostart at login', 'path':'config/autostart-at-login'},
            {'title': 'Run as non-root user', 'path':'config/non-root-user'},
        ]},
        {'title': 'Troubleshooting', 'sublinks': [
            {'title': 'Read this first', 'path':'bugs/policy'},
            {'title': 'Memory leaks', 'path':'bugs/debugging-memory-leaks'},
            {'title': 'SecComp', 'path':'bugs/Seccomp'},
            {'title': 'Analyzing network IO', 'path':'traffic-analysis'},
        ]},
        {'title': 'Known issues', 'sublinks': [
            {'title': 'Horizon', 'path':'bugs/horizon'},
            {'title': 'Black Hole', 'path':'bugs/black-hole'},
            {'title': 'Secret Santa', 'path':'bugs/santa'},
        ]},
        {'title': 'Configurator timeout', 'sublinks': [
            {'title': 'Firewall on localhost', 'path':'bugs/configurator-timeout'},
            {'title': 'UDP overflow', 'path':'bugs/connectTo-overflow'},
            {'title': 'Hidden Peers', 'path':'bugs/hidden-peers'},
        ]},
        {'title': 'OS/distro-specific quirks', 'path':'bugs/distro-quirks'},
        {'title': 'Reporting bugs', 'path':'bugs/reporting'}
    ]},
    {'title': 'Work In Progress', 'sublinks': [
        {'title': 'Interesting links', 'path':'notes/links'},
        {'title': "'ansuz' Q&A with Arceliar", 'path':'notes/arc-workings'},
        {'title': 'cjdns-core', 'path':'notes/cjdns-core'},
        {'title': 'cjdroute.conf', 'path':'notes/cryptography'},
        {'title': 'OS/distro-specific quirks', 'path':'notes/cjdroute-conf'},
        {'title': './do', 'path':'notes/do'},
        {'title': 'DNS ideas', 'path':'notes/dns'},
        {'title': 'DJC layer model', 'path':'djc-layer-model'},
        {'title': 'Benchmarks', 'path':'benchmark'},
        {'title': 'Fun with the switch', 'path':'switchfun'},
    ]}
]
%}



{# Render the menu on the left using sidebar_menu #}
{%- block sidebartoc %}
    <div id="page-menu">
    {%- include "localtoc.html" %}
    </div>
    <div id="website-menu">
    <h3><a href="{{ pathto('index') }}">Index</a></h3>
    <ul class="sidebar_menu">
        {% for link in sidebar_menu %}
            {% if link.sublinks %}
                <h4>{{ link.title }}</h4>
                {% for sublink1 in link.sublinks %}
                    {% if sublink1.sublinks %}
                        {% set current_page_in_sublinks = [] %}
                        {% for sublink2 in sublink1.sublinks %}
                            {% if sublink2.path == pagename %}
                                {% if current_page_in_sublinks.append(1) %}{% endif %}
                            {% endif %}
                        {% endfor %}
                        <div>
                            {{ input_label(sublink1, current_page_in_sublinks) }}
                            <ul>
                            {% for sublink2 in sublink1.sublinks %}
                                {{ render_li(sublink2) }}
                            {% endfor %}
                            </ul>
                        </div>
                    {% else %}
                        {{ render_li(sublink1) }}
                    {% endif %}
                {% endfor %}
            {% endif %}
        {% endfor %}
    </ul>
    </div>
    
{%- endblock %}


{# Render all entry in the menu who have a sublist #}
{%- macro input_label(sublink, current_page_in_sublinks) %}
    {% set current_page_is_link = (sublink.path and pagename == sublink.path) %}
    <label class="subtitle {% if current_page_is_link %} current-page {% endif %}" for="input-{{ sublink.title }}" {% if sublink.path %} onclick="window.location.href='{{ pathto(sublink.path) }}'"{% endif %} >{{ sublink.title }}</label>
    <input class="subtitle" type=radio id="input-{{ sublink.title }}" name="group" {% if current_page_in_sublinks or current_page_is_link %}checked{% endif %}>
    <i class="fa fa-caret-down {% if current_page_is_link %} current-page {% endif %}"></i>
{%- endmacro %}


{# Render all entry in the menu who do not have a sublist #}
{%- macro render_li(sublink) %}
    <li class="{% if pagename == sublink.path %}current-page {% endif %}{% if sublink.todo %}todo{% endif %}"><a {% if not pagename == sublink.path %} href="{{ pathto(sublink.path) }}" {% endif %}> {{ sublink.title }}</a></li>  
{%- endmacro %}
